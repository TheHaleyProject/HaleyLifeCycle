<?xml version="1.0" encoding="UTF-8" ?>
<project name="lifecycle_state" database="MariaDb" id="19f578f4-fff8-4e61-ac61-4d42ca9c2334" >
	<schema name="lcstate" >
		<table name="ack_log" prior="ack_l" >
			<column name="id" type="BIGINT" mandatory="y" >
				<identity><![CDATA[AUTO_INCREMENT]]></identity>
			</column>
			<column name="ack_status" type="INT" mandatory="y" >
				<defo><![CDATA[1]]></defo>
				<comment><![CDATA[Flag:
1 = Pending
2 = Delivered
3 = Processed (Idempotent)
4 = Failed]]></comment>
			</column>
			<column name="last_retry" type="DATETIME" mandatory="y" >
				<defo><![CDATA[CURRENT_TIMESTAMP]]></defo>
			</column>
			<column name="retry_count" type="INT" mandatory="y" >
				<defo><![CDATA[0]]></defo>
			</column>
			<column name="created" type="DATETIME" mandatory="y" >
				<defo><![CDATA[CURRENT_TIMESTAMP]]></defo>
			</column>
			<column name="modified" type="DATETIME" mandatory="y" >
				<defo><![CDATA[CURRENT_TIMESTAMP]]></defo>
				<column_options><![CDATA[ON UPDATE CURRENT_TIMESTAMP]]></column_options>
			</column>
			<column name="message_id" prior="guid" type="CHAR" length="36" mandatory="y" >
				<defo><![CDATA[uuid()]]></defo>
				<comment><![CDATA[Each consumer can have its own message id. When a transition happens, we can easily track what each consumer is doing with that transition.]]></comment>
			</column>
			<column name="transition_log" type="BIGINT" mandatory="y" />
			<column name="consumer" type="INT" mandatory="y" >
				<defo><![CDATA[0]]></defo>
				<comment><![CDATA[consumer of this acknowledgement]]></comment>
			</column>
			<index name="pk_ack_log" unique="PRIMARY_KEY" >
				<column name="id" />
			</index>
			<index name="fk_ack_log_transition_log" unique="NORMAL" >
				<column name="transition_log" />
			</index>
			<index name="unq_ack_log" unique="UNIQUE_KEY" >
				<column name="consumer" />
				<column name="transition_log" />
			</index>
			<index name="unq_ack_log_0" unique="UNIQUE_KEY" >
				<column name="message_id" />
			</index>
			<fk name="fk_ack_log_transition_log" to_schema="lcstate" to_table="transition_log" >
				<fk_column name="transition_log" pk="id" />
			</fk>
			<options><![CDATA[engine=InnoDB]]></options>
		</table>
		<table name="category" prior="tbl" >
			<column name="id" type="INT" mandatory="y" >
				<identity><![CDATA[AUTO_INCREMENT]]></identity>
			</column>
			<column name="display_name" type="VARCHAR" length="120" mandatory="y" />
			<column name="name" type="VARCHAR" length="120" >
				<identity><![CDATA[GENERATED  ALWAYS AS (lower(trim(display_name))) PERSISTENT]]></identity>
			</column>
			<index name="pk_tbl" unique="PRIMARY_KEY" >
				<column name="id" />
			</index>
			<index name="unq_category" unique="UNIQUE_KEY" >
				<column name="name" />
			</index>
			<options><![CDATA[engine=InnoDB]]></options>
		</table>
		<table name="def_version" prior="def_versio" >
			<column name="id" type="INT" mandatory="y" >
				<identity><![CDATA[AUTO_INCREMENT]]></identity>
			</column>
			<column name="guid" type="CHAR" length="36" mandatory="y" >
				<defo><![CDATA[uuid()]]></defo>
			</column>
			<column name="version" type="INT" mandatory="y" >
				<defo><![CDATA[1]]></defo>
			</column>
			<column name="created" type="DATETIME" mandatory="y" >
				<defo><![CDATA[CURRENT_TIMESTAMP]]></defo>
			</column>
			<column name="modified" type="DATETIME" mandatory="y" >
				<defo><![CDATA[CURRENT_TIMESTAMP]]></defo>
				<column_options><![CDATA[ON UPDATE CURRENT_TIMESTAMP]]></column_options>
			</column>
			<column name="parent" type="INT" mandatory="y" />
			<column name="data" type="LONGTEXT" mandatory="y" />
			<index name="unq_def_version" unique="UNIQUE_KEY" >
				<column name="parent" />
				<column name="version" />
			</index>
			<index name="fk_def_version_definition" unique="NORMAL" >
				<column name="parent" />
			</index>
			<index name="unq_def_version_0" unique="UNIQUE_KEY" >
				<column name="guid" />
			</index>
			<index name="pk_def_version" unique="PRIMARY_KEY" >
				<column name="id" />
			</index>
			<constraint name="cns_def_version" >
				<string><![CDATA[`version` > 0]]></string>
			</constraint>
			<constraint name="cns_def_version_0" >
				<string><![CDATA[json_valid(`data`)]]></string>
			</constraint>
			<fk name="fk_def_version_definition" to_schema="lcstate" to_table="definition" >
				<fk_column name="parent" pk="id" />
			</fk>
			<options><![CDATA[
 AUTO_INCREMENT 1990  
]]></options>
		</table>
		<table name="definition" prior="definit" >
			<column name="id" type="INT" mandatory="y" >
				<identity><![CDATA[AUTO_INCREMENT]]></identity>
				<comment><![CDATA[it should be a code provided by the user.]]></comment>
			</column>
			<column name="env" type="INT" mandatory="y" >
				<defo><![CDATA[0]]></defo>
			</column>
			<column name="guid" type="CHAR" length="36" mandatory="y" >
				<defo><![CDATA[uuid()]]></defo>
			</column>
			<column name="display_name" type="VARCHAR" length="200" mandatory="y" />
			<column name="name" type="VARCHAR" length="200" >
				<identity><![CDATA[GENERATED  ALWAYS AS (lower(trim(display_name))) PERSISTENT]]></identity>
			</column>
			<column name="description" type="TEXT" />
			<column name="created" prior="created_at" type="DATETIME" mandatory="y" >
				<defo><![CDATA[CURRENT_TIMESTAMP]]></defo>
			</column>
			<index name="pk_definition" unique="PRIMARY_KEY" >
				<column name="id" />
			</index>
			<index name="unq_definition" unique="UNIQUE_KEY" >
				<column name="env" />
				<column name="name" />
			</index>
			<index name="unq_definition_0" unique="UNIQUE_KEY" >
				<column name="guid" />
			</index>
			<fk name="fk_definition_environment" to_schema="lcstate" to_table="environment" >
				<fk_column name="env" pk="id" />
			</fk>
			<options><![CDATA[
 AUTO_INCREMENT 1998  ]]></options>
		</table>
		<table name="environment" prior="environme" >
			<comment><![CDATA[environment code
//Doesnt' need to be like dev/prod/test.. It can be an work-group environmetn as well..

//like preq-app (is one environment), so all preq-app (wherever it runs, local, production etc) will be able to read definitions.

//we can even extend it as , preq-app-dev, preq-app-prod etc.]]></comment>
			<column name="id" type="INT" mandatory="y" >
				<identity><![CDATA[AUTO_INCREMENT]]></identity>
			</column>
			<column name="display_name" type="VARCHAR" length="120" mandatory="y" />
			<column name="name" type="VARCHAR" length="120" >
				<identity><![CDATA[GENERATED  ALWAYS AS (lower(trim(display_name))) PERSISTENT]]></identity>
			</column>
			<column name="code" type="INT" mandatory="y" />
			<index name="pk_environment" unique="PRIMARY_KEY" >
				<column name="id" />
			</index>
			<index name="unq_environment" unique="UNIQUE_KEY" >
				<column name="code" />
			</index>
			<index name="unq_environment_0" unique="UNIQUE_KEY" >
				<column name="name" />
			</index>
			<options><![CDATA[engine=InnoDB]]></options>
		</table>
		<table name="events" prior="e" >
			<column name="id" type="INT" mandatory="y" >
				<identity><![CDATA[AUTO_INCREMENT]]></identity>
			</column>
			<column name="display_name" type="VARCHAR" length="120" mandatory="y" />
			<column name="code" type="INT" mandatory="y" />
			<column name="name" type="VARCHAR" length="120" >
				<identity><![CDATA[GENERATED  ALWAYS AS (lower(trim(display_name))) PERSISTENT]]></identity>
			</column>
			<column name="def_version" type="INT" mandatory="y" />
			<index name="pk_events" unique="PRIMARY_KEY" >
				<column name="id" />
			</index>
			<index name="unq_events" unique="UNIQUE_KEY" >
				<column name="def_version" />
				<column name="code" />
				<column name="name" />
			</index>
			<index name="unq_events_0" unique="UNIQUE_KEY" >
				<column name="def_version" />
				<column name="code" />
			</index>
			<fk name="fk_events_def_version" to_schema="lcstate" to_table="def_version" >
				<fk_column name="def_version" pk="id" />
			</fk>
			<options><![CDATA[engine=InnoDB]]></options>
		</table>
		<table name="instance" prior="insta" >
			<column name="current_state" type="INT" mandatory="y" />
			<column name="last_event" type="INT" mandatory="y" />
			<column name="guid" type="CHAR" length="36" mandatory="y" >
				<defo><![CDATA[uuid()]]></defo>
			</column>
			<column name="id" type="BIGINT" mandatory="y" >
				<identity><![CDATA[AUTO_INCREMENT]]></identity>
			</column>
			<column name="flags" type="INT" mandatory="y" unsigned="y" >
				<defo><![CDATA[0]]></defo>
				<comment><![CDATA[active =1,
suspended =2 ,
completed = 4,
failed = 8, 
archive = 16]]></comment>
			</column>
			<column name="def_version" type="INT" mandatory="y" />
			<column name="external_ref" type="CHAR" length="36" >
				<comment><![CDATA[like external workflow id or submission id or transmittal id.. Expected value is a GUID]]></comment>
			</column>
			<column name="created" type="DATETIME" mandatory="y" >
				<defo><![CDATA[CURRENT_TIMESTAMP]]></defo>
			</column>
			<column name="modified" type="DATETIME" mandatory="y" >
				<defo><![CDATA[CURRENT_TIMESTAMP]]></defo>
				<column_options><![CDATA[ON UPDATE CURRENT_TIMESTAMP]]></column_options>
			</column>
			<index name="pk_instance" unique="PRIMARY_KEY" >
				<column name="id" />
			</index>
			<index name="unq_instance" unique="UNIQUE_KEY" >
				<column name="guid" />
			</index>
			<index name="fk_instance_state" unique="NORMAL" >
				<column name="current_state" />
			</index>
			<index name="fk_instance_events" unique="NORMAL" >
				<column name="last_event" />
			</index>
			<index name="fk_instance_def_version" unique="NORMAL" >
				<column name="def_version" />
			</index>
			<index name="unq_instance_0" unique="UNIQUE_KEY" >
				<column name="def_version" />
				<column name="external_ref" />
			</index>
			<index name="idx_instance" unique="NORMAL" >
				<column name="external_ref" />
			</index>
			<fk name="fk_instance_def_version" to_schema="lcstate" to_table="def_version" >
				<fk_column name="def_version" pk="id" />
			</fk>
			<fk name="fk_instance_state" to_schema="lcstate" to_table="state" >
				<fk_column name="current_state" pk="id" />
			</fk>
			<fk name="fk_instance_events" to_schema="lcstate" to_table="events" >
				<fk_column name="last_event" pk="id" />
			</fk>
			<options><![CDATA[engine=InnoDB]]></options>
		</table>
		<table name="state" prior="tbl" >
			<column name="category" type="INT" mandatory="y" >
				<defo><![CDATA[0]]></defo>
			</column>
			<column name="id" type="INT" mandatory="y" >
				<identity><![CDATA[AUTO_INCREMENT]]></identity>
			</column>
			<column name="display_name" type="VARCHAR" length="200" mandatory="y" />
			<column name="name" type="VARCHAR" length="200" >
				<identity><![CDATA[GENERATED  ALWAYS AS (lower(trim(display_name))) PERSISTENT]]></identity>
			</column>
			<column name="flags" type="INT" mandatory="y" unsigned="y" >
				<defo><![CDATA[1]]></defo>
				<comment><![CDATA[is_initial = 1
is_final = 2
is_system = 4
is_error = 8]]></comment>
			</column>
			<column name="created" type="DATETIME" mandatory="y" >
				<defo><![CDATA[CURRENT_TIMESTAMP]]></defo>
			</column>
			<column name="def_version" type="INT" mandatory="y" />
			<column name="timeout_minutes" type="INT" >
				<comment><![CDATA[in minutes]]></comment>
			</column>
			<column name="timeout_mode" type="INT" mandatory="y" >
				<defo><![CDATA[0]]></defo>
				<comment><![CDATA[0 = Once
1 = Repeat]]></comment>
			</column>
			<column name="timeout_event" type="INT" />
			<index name="pk_state" unique="PRIMARY_KEY" >
				<column name="id" />
			</index>
			<index name="unq_state" unique="UNIQUE_KEY" >
				<column name="def_version" />
				<column name="name" />
			</index>
			<index name="fk_state_category" unique="NORMAL" >
				<column name="category" />
			</index>
			<index name="fk_state_events" unique="NORMAL" >
				<column name="timeout_event" />
			</index>
			<fk name="fk_state_def_version" to_schema="lcstate" to_table="def_version" >
				<fk_column name="def_version" pk="id" />
			</fk>
			<fk name="fk_state_category" to_schema="lcstate" to_table="category" >
				<fk_column name="category" pk="id" />
			</fk>
			<fk name="fk_state_events" to_schema="lcstate" to_table="events" >
				<fk_column name="timeout_event" pk="id" />
			</fk>
			<options><![CDATA[engine=InnoDB
 AUTO_INCREMENT 2014 
]]></options>
		</table>
		<table name="transition" prior="transi" >
			<column name="id" type="INT" mandatory="y" >
				<identity><![CDATA[AUTO_INCREMENT]]></identity>
			</column>
			<column name="from_state" type="INT" mandatory="y" />
			<column name="to_state" type="INT" mandatory="y" />
			<column name="created" type="DATETIME" mandatory="y" >
				<defo><![CDATA[CURRENT_TIMESTAMP]]></defo>
			</column>
			<column name="def_version" prior="def" type="INT" mandatory="y" />
			<column name="event" type="INT" mandatory="y" />
			<index name="pk_transition" unique="PRIMARY_KEY" >
				<column name="id" />
			</index>
			<index name="unq_transition" unique="UNIQUE_KEY" >
				<column name="def_version" />
				<column name="from_state" />
				<column name="to_state" />
				<column name="event" />
			</index>
			<index name="fk_transition_state" unique="NORMAL" >
				<column name="from_state" />
			</index>
			<index name="fk_transition_state_0" unique="NORMAL" >
				<column name="to_state" />
			</index>
			<index name="fk_transition_events" unique="NORMAL" >
				<column name="event" />
			</index>
			<fk name="fk_transition_state" to_schema="lcstate" to_table="state" >
				<fk_column name="from_state" pk="id" />
			</fk>
			<fk name="fk_transition_state_0" to_schema="lcstate" to_table="state" >
				<fk_column name="to_state" pk="id" />
			</fk>
			<fk name="fk_transition_def_version" to_schema="lcstate" to_table="def_version" >
				<fk_column name="def_version" pk="id" />
			</fk>
			<fk name="fk_transition_events" to_schema="lcstate" to_table="events" >
				<fk_column name="event" pk="id" />
			</fk>
			<options><![CDATA[engine=InnoDB]]></options>
		</table>
		<table name="transition_data" prior="transition_da" >
			<column name="transition_log" type="BIGINT" mandatory="y" />
			<column name="actor" type="VARCHAR" length="255" />
			<column name="metadata" type="LONGTEXT" >
				<comment><![CDATA[Could be any data that was the result of this transition (which could be later used as a reference or  input for other items)]]></comment>
			</column>
			<index name="pk_transition_data" unique="PRIMARY_KEY" >
				<column name="transition_log" />
			</index>
			<fk name="fk_transition_data_transition_log" to_schema="lcstate" to_table="transition_log" >
				<fk_column name="transition_log" pk="id" />
			</fk>
			<options><![CDATA[engine=InnoDB]]></options>
		</table>
		<table name="transition_log" prior="transition_l" >
			<column name="id" type="BIGINT" mandatory="y" >
				<identity><![CDATA[AUTO_INCREMENT]]></identity>
			</column>
			<column name="instance_id" type="BIGINT" mandatory="y" />
			<column name="from_state" type="INT" mandatory="y" />
			<column name="to_state" type="INT" mandatory="y" />
			<column name="event" type="INT" mandatory="y" />
			<column name="created" type="DATETIME" mandatory="y" >
				<defo><![CDATA[utc_timestamp()]]></defo>
			</column>
			<index name="pk_transition_log" unique="PRIMARY_KEY" >
				<column name="id" />
			</index>
			<index name="fk_transition_log_instance" unique="NORMAL" >
				<column name="instance_id" />
			</index>
			<fk name="fk_transition_log_instance" to_schema="lcstate" to_table="instance" >
				<fk_column name="instance_id" pk="id" />
			</fk>
			<options><![CDATA[engine=InnoDB]]></options>
		</table>
	</schema>
	<layout name="Default Diagram" id="18212873-6564-437d-a8a1-bcd5f7f6492f" confirmed="y" joined_routing="y" show_relation="cascade" >
		<entity schema="lcstate" name="transition_log" color="FFFF00" x="57" y="418" />
		<entity schema="lcstate" name="transition_data" color="FFFF00" x="57" y="266" />
		<entity schema="lcstate" name="category" color="0000FF" x="722" y="95" />
		<entity schema="lcstate" name="instance" color="FFFF00" x="247" y="437" />
		<entity schema="lcstate" name="transition" color="0000FF" x="760" y="228" />
		<entity schema="lcstate" name="def_version" color="0000FF" x="475" y="532" />
		<entity schema="lcstate" name="events" color="0000FF" x="760" y="456" />
		<entity schema="lcstate" name="definition" color="0000FF" x="627" y="627" />
		<entity schema="lcstate" name="environment" color="0000FF" x="798" y="646" />
		<entity schema="lcstate" name="state" color="0000FF" x="475" y="228" />
		<entity schema="lcstate" name="ack_log" color="FFFF00" x="247" y="190" />
		<group name="BluePrint" color="0000FF" >
			<entity schema="lcstate" name="category" />
			<entity schema="lcstate" name="transition" />
			<entity schema="lcstate" name="def_version" />
			<entity schema="lcstate" name="events" />
			<entity schema="lcstate" name="definition" />
			<entity schema="lcstate" name="environment" />
			<entity schema="lcstate" name="state" />
		</group>
		<group name="State Info" color="FFFF00" >
			<entity schema="lcstate" name="transition_log" />
			<entity schema="lcstate" name="transition_data" />
			<entity schema="lcstate" name="instance" />
			<entity schema="lcstate" name="ack_log" />
		</group>
	</layout>
</project>